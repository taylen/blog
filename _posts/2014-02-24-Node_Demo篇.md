---
layout: post
title: Node Demo篇
---

{{ page.title }}
=================

<p class="meta">24 Feb 2014 - Node Demo篇</p>
<p class="meta">Author: Taylen</p>

<p>
	<h2>
		Demo One: HTTP Post
	</h2>
	<p style="white-space:pre-wrap;background-color:rgb(214, 235, 214);font-family:consolas;">
		var http = require("http");
		var querystring = require("querystring");

		http.createServer(function(req, res){
			var postDate = "";
			req.setEncoding("utf8");
			req.on("data", function(piece){
				postData += piece;
			});
			req.on("end", function(){
				res.end("Hello World: "+ postData);
			});
		}).listen(1337);
		console.log("server begin success.");
	</p>
</p>

<p>
	<h2>
		Demo Two: HTTP Get
	</h2>
	<p style="white-space:pre-wrap;background-color:rgb(214, 235, 214);font-family:consolas;">
		var http = require("http");
		var url = require("url");

		http.createServer(function(req, res){
			var getData = url.parse(req.url).pathname;
			console.log("Request for "+getData+" Received.");
			res.writeHead(200, {"Content-Type": "text/plain"});
			//res.writeHead(302, {"location": "http://www.baidu.com"});
			res.end("Hello World "+ getData);
		}).listen(1337);
		console.log("server begin success.");
	</p>
</p>

<p>
	<h2>
		Demo Three: 定时器
	</h2>
	<p style="white-space:pre-wrap;background-color:rgb(214, 235, 214);font-family:consolas;">
		process.nextTick(function(){
			console.log('next Tick delay execute one.');
		});
		process.nextTick(function(){
			console.log('next Tick delay execute two.');
		});

		setImmediate(function(){
			console.log('setImmediate delay execute one.');
			process.nextTick(function(){
				console.log("insert force.");
			});
		});
		setImmediate(function(){
			console.log("setImmediate delay execute two.");
		});
		console.log("execute success.");


		//result
		execute success.
		next Tick delay execute one.
		next Tick delay execute two.
		setImmediate delay execute one.
		insert force.
		setImmediate delay execute two.


		setImmediate(function(){
			console.log('setImmediate delay execute one.');
			process.nextTick(function(){
				console.log("insert force.");
			});
		});
		setImmediate(function(){
			console.log("setImmediate delay execute two.");
		});

		setTimeout(function(){
			console.log('setTimeout execute one.');
		}, 0);

		process.nextTick(function(){
			console.log('next Tick delay execute one.');
			process.nextTick(function(){
				console.log("insert force two.");
			});
		});
		console.log("execute success.");

		//result
		execute success.
		next Tick delay execute one.
		insert force two.
		setTimeout execute one.
		setImmediate delay execute one.
		insert force.
		setImmediate delay execute two.


		解析：定时器的结果，始终遵循着一个原则，就是process.nextTick属于IDLE观察者，setImmediate属于check观察者，setTimeout可以看做IO观察者；而idle观察者先于IO观察者，IO观察者先于check观察者。
	</p>
</p>

<p>
	<h2>
		Demo Four: 异步并发控制-bagpipe解决方案
	</h2>
	<p style="white-space:pre-wrap;background-color:rgb(214, 235, 214);font-family:consolas;">
		//使用方法如下：
		var Bagpipe = require('bagpipe');
		//设定最大并发数
		var bagpipe = new Bagpipe(10, {
			refuse: false,
			timeout: 3000
		});
		for(var i = 0; i < 100; i++){
			bagpipe.push(async, function(){
				//异步回调执行
			});
		}
		bagpipe.on('full', function(length){
			console.log('队列拥堵，目前队列长度：'+length);
		});
		//原理简介
		var Bagpipe = {};
		Bagpipe.prototype.push = function(method){
			var args = [].slice.call(arguments, 1);
			var callback = args[args.length - 1];
			if(typeof callback !== 'function'){
				args.push(function(){});
			}
			if(this.options.disabled || this.limit < 1){
				method.apply(null, args);
				return this;
			}
			if(this.queue.length < this.queueLength || !this.options.refuse){
				this.queue.push({
					method: method,
					args: args
				});
			}else{
				var err = new Error('Too much async call in queue');
				err.name = "TooMuchAsyncCallError";
				callback(err);
			}
			if(this.queue.length > 1){
				this.emit('full', this.queue.length);
			}
			this.next();
			return this;
		};
		Bagpipe.prototype.next = function(){
			//...
		};
		Bagpipe.prototype.run = function(){
			//...
		};
	</p>
</p>

<p>
	后续敬请期待
</p>

本文摘自 朴灵《深入浅出NodeJS》

